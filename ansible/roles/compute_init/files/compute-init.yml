---

- name: Compute node initialisation
  hosts: localhost
  become: yes
  vars:
    os_metadata: "{{ lookup('url', 'http://169.254.169.254/openstack/latest/meta_data.json') | from_json }}"
    server_node_ip: "{{ os_metadata.meta.k3s_server }}"
    compute_groups: "{{ os_metadata.meta.compute_groups | default([]) }}"

    # TODO: "= role defaults" - could be moved to a vars_file: on play with similar precedence effects
    # this is a good example: common environment actually defines this (non-functional w/o compute groups), but role default is empty
    resolv_conf_nameservers: []
    
  tasks:
    - block:
        - name: Report skipping initialization if not compute node
          # meta: end_play produces no output
          debug:
            msg: "Skipping compute initialization as metadata compute_groups is empty"
        
        - meta: end_play
      when: compute_groups | length == 0 

    - name: Ensure the mount directory exists
      file:
        path: /mnt/cluster
        state: directory
        owner: root
        group: root
        mode: u=rwX,go= # is sensitive
    
    - name: Mount /mnt/cluster
      mount:
        path: /mnt/cluster
        src: "{{ server_node_ip }}:/exports/cluster"
        fstype: nfs
        opts: ro,sync
        state: mounted
      register: nfs_mount_result
      ignore_errors: true
      register: _mount_mnt_cluster
      # TODO: add some retries here?

    - block:
        - name: Report skipping initialization if cannot mount nfs
          # meta: end_play produces no output
          debug:
            msg: "Skipping compute initialization as cannot mount exports/cluster share"
        
        - meta: end_play
      when: _mount_mnt_cluster.failed

    - name: Load hostvars from NFS
      # this is higher priority than vars block = normal ansible's hostvars
      include_vars:
        file: "/mnt/cluster/hostvars/{{ ansible_hostname }}/hostvars.yml" # can't use inventory_hostname

    - name: Demonstrate hostvars have loaded
      debug:
        var: prometheus_version
