- hosts: basic_users:!builder
  become: yes
  tags:
    - basic_users
    - users
  gather_facts: yes
  tasks:
    - import_role:
        name: basic_users

- name: Setup EESSI
  hosts: eessi
  tags: eessi
  become: true
  gather_facts: false
  tasks:
    - name: Install and configure EESSI
      import_role:
        name: eessi

- name: Setup CUDA
  hosts: cuda
  become: yes
  gather_facts: yes
  tags: cuda
  tasks:
    - import_role:
        name: cuda

- name: Persist hostkeys across rebuilds
  # Must be after filesystems.yml (for storage)
  # and before portal.yml (where OOD login node hostkeys are scanned)
  hosts: persist_hostkeys:!builder
  become: yes
  gather_facts: no
  tasks:
    - import_role:
        name: persist_hostkeys

# TODO: I'm not convinced this is the right place
- hosts: compute_init:!builder
  tags: compute_init
  become: yes
  name: Export hostvars
  tasks:
    - include_role:
        name: compute_init
        tasks_from: export.yml

# TODO: really this should only run during build
# but handy not to for debugging without build
- name: Install compute_init script
  hosts: compute_init
  tags: compute_init
  become: yes
  tasks:
    - include_role:
        name: compute_init
        tasks_from: install.yml

- name: Install k9s
  become: yes
  hosts: k9s
  tags: k9s
  tasks:
  - import_role:
      name: k9s
